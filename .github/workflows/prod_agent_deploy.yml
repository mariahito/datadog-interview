name: CD - Production Release (Operator)

on:
  workflow_dispatch: # Manual Trigger
  release:           # Automated Trigger
    types: [published]

permissions:
  id-token: write
  contents: read

jobs:
  # ---------------------------------------------------------
  # JOB 1: PREPARE (Fetch Infrastructure Data) - Unchanged
  # ---------------------------------------------------------
  prepare-inventory:
    name: "Gen Inventory"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::404612059897:role/GitHubActionRole
          aws-region: us-east-1
      - uses: hashicorp/setup-terraform@v3
      - name: Generate Inventory & Key
        working-directory: ./terraform
        run: |
          terraform init
          terraform output -raw private_key > ../ansible_key.pem
          chmod 600 ../ansible_key.pem
          PROD_IP=$(terraform output -raw prod_ip)
          echo "[prod]" > ../inventory.ini
          echo "$PROD_IP ansible_user=ubuntu env_tag=prod hostname_alias=Datadog-Demo-Prod" >> ../inventory.ini
      - uses: actions/upload-artifact@v4
        with:
          name: deployment-artifacts
          path: |
            inventory.ini
            ansible_key.pem
          retention-days: 1
          overwrite: true

  # ---------------------------------------------------------
  # JOB 2: DEPLOY TO PROD (Operator + Custom Resource)
  # ---------------------------------------------------------
  deploy-prod:
    name: "Deploy Production"
    needs: prepare-inventory
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with: { name: deployment-artifacts }
      - run: chmod 600 ansible_key.pem

      - name: Install Dependencies
        run: |
          pip install kubernetes ansible
          ansible-galaxy collection install kubernetes.core
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" && chmod +x kubectl && sudo mv kubectl /usr/local/bin/

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::404612059897:role/GitHubActionRole
          aws-region: us-east-1

      - name: Fetch Secrets
        run: |
          SECRET_JSON=$(aws secretsmanager get-secret-value --secret-id prod/datadog/keys --region us-east-1 --query SecretString --output text)
          echo "DD_API_KEY=$(echo $SECRET_JSON | jq -r .DD_API_KEY)" >> $GITHUB_ENV

      - name: Run Playbook (PROD)
        run: |
          export ANSIBLE_HOST_KEY_CHECKING=False
          
          # Dry Run first to validate the Custom Resource schema
          echo "--- STARTING PROD DRY RUN ---"
          ansible-playbook -i inventory.ini ansible/setup-microk8s.yml --check --private-key ansible_key.pem --limit prod -u ubuntu
          ansible-playbook -i inventory.ini ansible/setup-datadog.yml --check --private-key ansible_key.pem --limit prod -u ubuntu \
            --extra-vars "datadog_api_key=${{ env.DD_API_KEY }} \
            process_agent_enabled=true \
            logs_enabled=${{ vars.LOGS_ENABLED }} \
            orchestrator_explorer_enabled=${{ vars.ORCHESTRATOR_EXPLORER_ENABLED }} \
            apm_enabled=${{ vars.APM_ENABLED }} \
            agent_request_memory=${{ vars.AGENT_REQ_MEM }} \
            agent_limit_memory=${{ vars.AGENT_LIM_MEM }} \
            agent_request_cpu=${{ vars.AGENT_REQ_CPU }} \
            agent_limit_cpu=${{ vars.AGENT_LIM_CPU }}"

          # Actual Deployment
          - name: "Actual Prod Deployment"
            run: |
              export ANSIBLE_HOST_KEY_CHECKING=False
              echo "--- APPLYING PROD CHANGES ---"
              ansible-playbook -i inventory.ini ansible/setup-microk8s.yml --private-key ansible_key.pem --limit prod -u ubuntu
              ansible-playbook -i inventory.ini ansible/setup-datadog.yml --private-key ansible_key.pem --limit prod -u ubuntu \
                --extra-vars "datadog_api_key=${{ env.DD_API_KEY }} \
                process_agent_enabled=true \
                logs_enabled=${{ vars.LOGS_ENABLED }} \
                orchestrator_explorer_enabled=${{ vars.ORCHESTRATOR_EXPLORER_ENABLED }} \
                apm_enabled=${{ vars.APM_ENABLED }} \
                agent_request_memory=${{ vars.AGENT_REQ_MEM }} \
                agent_limit_memory=${{ vars.AGENT_LIM_MEM }} \
                agent_request_cpu=${{ vars.AGENT_REQ_CPU }} \
                agent_limit_cpu=${{ vars.AGENT_LIM_CPU }}"

      # ---------------------------------------------------------
      # PHASE 3: PROD HEALTH VERIFICATION
      # ---------------------------------------------------------
      - name: "Health Check  & App Deployment (PROD)"
        run: |
          echo "--- VERIFYING PROD ROLLOUT ---"
          export ANSIBLE_HOST_KEY_CHECKING=False
          
          # 1. Verify Operator Availability
          ansible prod -i inventory.ini --private-key ansible_key.pem -u ubuntu --become \
            -m shell -a "export PATH=\$PATH:/snap/bin; microk8s kubectl rollout status deployment/datadog-operator -n datadog-agent --timeout=60s"
          
          # 2. Verify Agent DaemonSet (Managed by Operator)
          ansible prod -i inventory.ini --private-key ansible_key.pem -u ubuntu --become \
            -m shell -a "export PATH=\$PATH:/snap/bin; microk8s kubectl rollout status daemonset/datadog-agent -n datadog-agent --timeout=60s"
          ansible prod -i inventory.ini --private-key ansible_key.pem -u ubuntu --become \
            -m shell -a "
              export PATH=\$PATH:/snap/bin; 
              for i in {1..10}; do 
                if microk8s kubectl exec -n datadog-agent daemonset/datadog-agent -c agent -- agent status | grep -i 'API Key'; then
                  echo 'Health Check Passed: API Key Validated';
                  exit 0;
                fi;
                echo 'Waiting for API Key validation (attempt \$i/10)...';
                sleep 10;
              done;
              echo 'Health Check Failed: API Key never validated';
              exit 1;
            "
          ansible-playbook -i inventory.ini ansible/deploy-app.yml \
            --private-key ansible_key.pem --limit test -u ubuntu
