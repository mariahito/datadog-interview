apiVersion: datadoghq.com/v2alpha1
kind: DatadogAgent
metadata:
  name: datadog
spec:
  global:
    clusterName: "{{ cluster_name_val }}"
    site: "{{ datadog_site }}"
    kubelet:
      tlsVerify: false
    credentials:
      apiSecret:
        secretName: datadog-secret
        keyName: api-key
  
  features:
    liveProcessCollection:
      enabled: {{ process_agent_enabled | lower }}
    logCollection:
      enabled: {{ logs_enabled | lower }}
      containerCollectAll: true
    orchestratorExplorer:
      enabled: true

  override:
    nodeAgent:
      # CRITICAL: Required for MicroK8s to reach the Kubelet
      hostNetwork: true
      containers:
        agent:
          resources:
            requests:
              cpu: "{{ agent_request_cpu }}"
              memory: "{{ agent_request_memory }}"
            limits:
              cpu: "{{ agent_limit_cpu }}"
              memory: "{{ agent_limit_memory }}"
      env:
        - name: DD_HOSTNAME
          value: "{{ hostname_alias }}"
        - name: DD_CLOUD_PROVIDER_METADATA
          value: "false"
        - name: DD_EC2_METADATA_ENABLED
          value: "false"
        - name: DD_KUBELET_TLS_VERIFY
          value: "false"
        - name: DD_KUBERNETES_KUBELET_HOST
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
